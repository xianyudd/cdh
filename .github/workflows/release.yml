name: release
# ---------------------------
# 自动化构建与发布流程：
# - 当推送 tag（vX.Y.Z）时触发
# - 可手动执行（workflow_dispatch）
# ---------------------------

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# 允许此 Workflow 写入 Release
permissions:
  contents: write

jobs:
  # ==========================
  # 1. 测试阶段（仅在 Linux）
  # ==========================
  test:
    name: Test (ubuntu)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --locked --all

  # ==========================
  # 2. 构建与发布阶段
  # ==========================
  build-and-release:
    name: Build ${{ matrix.target }} and publish
    needs: [test]  # 等待测试完成后再执行
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz

    steps:
      # 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 安装 Rust
      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # 缓存 Cargo 构建目录
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2

      # 编译 release 版本
      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      # 可执行文件瘦身（Linux）
      - name: Strip binary (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: strip "target/${{ matrix.target }}/release/cdh" || true

      # 可执行文件瘦身（macOS）
      - name: Strip binary (macOS)
        if: matrix.os == 'macos-latest'
        run: strip -x "target/${{ matrix.target }}/release/cdh" || true

      # 打包构建产物
      - name: Package artifacts
        shell: bash
        run: |
          set -euxo pipefail
          APP_NAME=cdh
          VERSION=${GITHUB_REF_NAME}  # 形如 v0.1.1
          TARGET=${{ matrix.target }}
          OUT_DIR="dist/${APP_NAME}-${VERSION}-${TARGET}"

          mkdir -p "${OUT_DIR}"
          cp "target/${TARGET}/release/${APP_NAME}" "${OUT_DIR}/"
          cp -f LICENSE README.md scripts/install.sh "${OUT_DIR}/" || true

          # 打包为 tar.gz
          tar -C dist -czf "${OUT_DIR}.tar.gz" "$(basename "${OUT_DIR}")"

          # 生成 sha256 校验文件
          if command -v sha256sum >/dev/null 2>&1; then
            (cd dist && sha256sum "$(basename "${OUT_DIR}").tar.gz" > "$(basename "${OUT_DIR}").tar.gz.sha256")
          else
            (cd dist && shasum -a 256 "$(basename "${OUT_DIR}").tar.gz" | awk '{print $1}' > "$(basename "${OUT_DIR}").tar.gz.sha256")
          fi

      # 上传到 CI Artifact（用于调试）
      - name: Upload artifacts for inspection
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: dist/*

      # 发布到 GitHub Release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # 上传所有 tar.gz 和校验文件
          files: |
            dist/**/*.tar.gz
            dist/**/*.tar.gz.sha256

          # 使用本地说明文件作为 release 描述
          body_path: scripts/release_notes/${{ github.ref_name }}.md

          # 不自动生成说明
          generate_release_notes: false

          # 覆盖旧文件（v2 版字段）
          overwrite_files: true

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
